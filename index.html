<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            color: #333;
            text-align: center;
        }

        canvas {
            width: 100% !important;
            height: 300px !important;
        }

        .wind-rose {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .wind-day {
            text-align: center;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 5px;
            min-width: 80px;
        }

    </style>
</head>

<body>
    <h1>Weather Dashboard</h1>
    <div class="dashboard">
        <div class="chart-container">
            <h2>Min Temperature (Last 2 Weeks)</h2>
            <canvas id="minTempChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>Forecast Temperature (Next Week)</h2>
            <canvas id="forecastTempChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>Humidity (Last 2 Weeks)</h2>
            <canvas id="pastHumidityChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>Humidity Forecast (Next Week)</h2>
            <canvas id="forecastHumidityChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>Wind Forecast (Next Week)</h2>
            <div class="wind-rose" id="windRose"></div>
        </div>
        <div class="chart-container">
            <h2>Historical Avg Temperature (2020-2024)</h2>
            <canvas id="historicalTempChart"></canvas>
        </div>
    </div>

    <script>
        // Coordinates
        const latitude = 55.0718472;
        const longitude = 29.5065049;

        // Current date handling
        const today = new Date();
        const twoWeeksAgo = new Date();
        twoWeeksAgo.setDate(today.getDate() - 14);

        // Format dates for API
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // Fetch weather data
        async function fetchWeatherData() {
            try {
                // Past 2 weeks data
                const pastResponse = await fetch(
                    `https://archive-api.open-meteo.com/v1/archive?latitude=${latitude}&longitude=${longitude}&start_date=${formatDate(twoWeeksAgo)}&end_date=${formatDate(today)}&daily=temperature_2m_min,relative_humidity_2m_mean&timezone=auto`
                );
                const pastData = await pastResponse.json();

                // Next week forecast
                const forecastResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=temperature_2m_min,relative_humidity_2m_mean,wind_speed_10m_max,wind_direction_10m_dominant&forecast_days=7&timezone=auto`
                );
                const forecastData = await forecastResponse.json();

                // Historical data (2020-2024)
                const historicalPromises = [];
                for (let year = 2020; year <= 2024; year++) {
                    const startDate = `${year}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    const startDateJs = new Date(startDate);

                    const lastDate = new Date(startDate);
                    lastDate.setDate(startDateJs.getDate() + 7);

                    const endDate = `${year}-${String(lastDate.getMonth() + 1).padStart(2, '0')}-${String(lastDate.getDate()).padStart(2, '0')}`;

                    historicalPromises.push(
                        fetch(`https://archive-api.open-meteo.com/v1/archive?latitude=${latitude}&longitude=${longitude}&start_date=${startDate}&end_date=${endDate}&daily=temperature_2m_mean&timezone=auto`)
                            .then(res => res.json())
                            .then(data => ({
                                year,
                                data: data.daily
                            }))
                    );
                }
                const historicalData = await Promise.all(historicalPromises);

                // Process and display all data
                processData(pastData, forecastData, historicalData);
            } catch (error) {
                console.error("Error fetching weather data:", error);
            }
        }

        function processData(pastData, forecastData, historicalData) {
            // 1. Min Temperature Last 2 Weeks
            createChart(
                'minTempChart',
                'line',
                pastData.daily.time,
                pastData.daily.temperature_2m_min,
                'Min Temperature (°C)',
                'rgba(255, 99, 132, 1)'
            );

            // 2. Forecast Temperature Next Week
            createChart(
                'forecastTempChart',
                'line',
                forecastData.daily.time,
                forecastData.daily.temperature_2m_min,
                'Forecast Temperature (°C)',
                'rgba(54, 162, 235, 1)'
            );

            // 3. Humidity Last 2 Weeks
            createChart(
                'pastHumidityChart',
                'bar',
                pastData.daily.time,
                pastData.daily.relative_humidity_2m_mean,
                'Humidity (%)',
                'rgba(75, 192, 192, 0.7)'
            );

            // 4. Humidity Forecast Next Week
            createChart(
                'forecastHumidityChart',
                'bar',
                forecastData.daily.time,
                forecastData.daily.relative_humidity_2m_mean,
                'Humidity Forecast (%)',
                'rgba(153, 102, 255, 0.7)'
            );

            // 5. Wind Forecast (Wind Rose)
            createWindRose(forecastData.daily);

            // 6. Historical Average Temperature
            createHistoricalChart(historicalData);
        }

        function createChart(canvasId, type, labels, data, label, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: color,
                        borderColor: color,
                        borderWidth: 1,
                        fill: type === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        function createWindRose(dailyData) {
            const windRoseContainer = document.getElementById('windRose');

            dailyData.time.forEach((date, index) => {
                const windDay = document.createElement('div');
                windDay.className = 'wind-day';

                const dateEl = document.createElement('div');
                dateEl.textContent = date;

                const directionEl = document.createElement('div');
                directionEl.textContent = `⇨`;
                directionEl.style.transform = `rotate(-${dailyData.wind_direction_10m_dominant[index]}deg)`;
                directionEl.style.fontSize = '24px';

                const speedEl = document.createElement('div');
                speedEl.textContent = `${dailyData.wind_speed_10m_max[index]} km/h`;

                windDay.appendChild(dateEl);
                windDay.appendChild(directionEl);
                windDay.appendChild(speedEl);
                windRoseContainer.appendChild(windDay);
            });
        }

        function createHistoricalChart(historicalData) {
            const ctx = document.getElementById('historicalTempChart').getContext('2d');

            // Prepare datasets for each year
            const datasets = historicalData.map(yearData => {
                const year = yearData.year;
                const color = getRandomColor();

                return {
                    label: year,
                    data: yearData.data.temperature_2m_mean,
                    borderColor: color,
                    backgroundColor: color,
                    borderWidth: 2,
                    pointRadius: 5,
                    fill: false
                };
            });

            // Use the first year's dates as labels (all should be the same)
            const labels = historicalData[0].data.time.map(date =>
                date.split('-').slice(1).join('-') // Remove year from date
            );

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', fetchWeatherData);
    </script>
</body>

</html>
